name: on_tag
on:
  push:
    tags:
    - 'v[0-9]+.[0-9]+.[0-9]+'  # Only build tag with semantic versioning format

permissions:
  contents: read

jobs:

  release:
    env:
      IMG_NAME: node-role-controller
      GO_VERSION: '1.25.0'
      COSIGN_VERSION: v2.5.0
      KIND_VERSION: '0.29.0'
      K8S_VERSION: '1.33.x'
      GO_LINTER_VERSION: 'v2.4.0'
      ERR_VULNERABILITY_SEV: 'CRITICAL,HIGH,MEDIUM'
      DEPLOYMENT_PATCH_FILE: deployment/overlays/dev/patch-deployment.yaml
      WORKER_NODE_COUNT: '2'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      id-token: write
    steps:

    # checkout the code
    - uses: mchmarny/common/go-test@743e9bd3a364a9ec749fe91c8728f6696b239245
      with:
        go-version: ${{ env.GO_VERSION }}
        scan-severity: ${{ env.ERR_VULNERABILITY_SEV }}
        linter-version: ${{ env.GO_LINTER_VERSION }}

    # build the image
    - uses: mchmarny/common/go-build@743e9bd3a364a9ec749fe91c8728f6696b239245
      id: build
      with:
        go-version: ${{ env.GO_VERSION }}
        image-uri: ${{ env.IMG_NAME }}
        release-version: ${{ github.ref_name }}
        main-path: main.go

    # runt integration tests with kind
    - uses: chainguard-dev/actions/setup-kind@b1933e3d1f574c772dc7efd68c2060dafbc25e8c  # v1.4.9
      with:
        kind-version: ${{ env.KIND_VERSION }}
        k8s-version: ${{ env.K8S_VERSION }}
        kind-worker-count: ${{ env.WORKER_NODE_COUNT }}
    - run: tests/set-dev-image ${{ steps.build.outputs.digest }} ${{ env.DEPLOYMENT_PATCH_FILE }}
    - run: tests/integration ${{ env.WORKER_NODE_COUNT }}

    # scan the image for vulnerabilities
    - uses: mchmarny/common/image-scan@743e9bd3a364a9ec749fe91c8728f6696b239245
      with:
        image-uri: ${{ steps.build.outputs.digest }}
        scan-severity: ${{ env.ERR_VULNERABILITY_SEV }}

    # sign the image with cosign
    - uses: mchmarny/common/image-sign@743e9bd3a364a9ec749fe91c8728f6696b239245
      with:
        image-uri: ${{ steps.build.outputs.digest }}
        image-tag: ${{ github.ref_name }}
        cosign-version: ${{ env.COSIGN_VERSION }}
        keyless-signing: true

    # attest the image
    - uses: mchmarny/common/image-attest@743e9bd3a364a9ec749fe91c8728f6696b239245
      with:
        image-uri: ${{ steps.build.outputs.digest }}
        cosign-version: ${{ env.COSIGN_VERSION }}
